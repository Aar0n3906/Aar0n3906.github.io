---
layout:     post
title:      å¯¹æŸæ•°å­—å£³appçš„åˆ†æ
subtitle:   Become Great
date:       2024-8-13
author:     Aaron
header-img: img/breakingbad.png
catalog: true
tags:
    - Android
    - è„±å£³
---

# å¯¹360å£³çš„åˆ†ææµç¨‹

æ‹¿åˆ°ğŸ–ç»™çš„ä¸€ä¸ªappï¼Œé©¬ä¸Špushæ¥è¿›è¡Œ360å…è´¹å£³çš„åˆ†æ

## Javaå±‚çš„å‰ç½®åˆ†æ

ä½¿ç”¨jadxæ‰“å¼€å¯ä»¥çœ‹åˆ°**StubApp** å’Œ **tianyu.util** ä»¥åŠ **libjiagu**ï¼Œè¿™äº›æ˜¯360åŠ å›ºçš„ä¸€äº›ç‰¹å¾ç‚¹

![image-20240813202852494](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240813202852494.png)

![image-20240813203837924](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240813203837924.png)

åœ¨**`attchBaseContext()`**ä¸­æœ‰åŠ å¯†çš„å­—ç¬¦ä¸²
![image-20240813204228308](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240813204228308.png)

åœ¨å·¦è¾¹çš„**`Smail`**ä»£ç ä¸­å¯ä»¥çœ‹åˆ°æ··æ·†çš„å­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬ä½¿ç”¨**`jeb`**ä¼šå°†åŠ å¯†å­—ç¬¦ä¸²è°ƒç”¨è§£å¯†å‡½æ•°è‡ªåŠ¨è§£å¯†
å½“åœ¨**`jadx`**ä¸­å¯ä»¥çœ‹åˆ°è¿™äº›åŠ å¯†å­—ç¬¦ä¸²åœ¨è¿è¡Œæ—¶è‡ªåŠ¨è°ƒç”¨äº†è§£å¯†å‡½æ•°
![image-20240813204745267](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240813204745267.png)

æ‰€è°“çš„è§£å¯†å‡½æ•°å°±æ˜¯å°†åŠ å¯†å­—ç¬¦ä¸²å¼‚æˆ–äº†16ä½œä¸ºç®€å•çš„æ··æ·†ï¼Œå…¶ä¸­çš„\u007Fæ˜¯Unicodeä»£ç ï¼Œä»£è¡¨hexçš„0x7f

![image-20240813205531508](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240813205531508.png)

ä¸‹æ–¹å¯ä»¥çœ‹åˆ°å¯¹ä¸åŒæ¶æ„åˆ†åˆ«åŠ è½½ä¸åŒçš„soæ–‡ä»¶

![image-20240813210116918](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240813210116918.png)

## Nativeå±‚åˆ†æ

### å£³elfæ–‡ä»¶å¯¼å…¥å¯¼å‡ºè¡¨çš„ä¿®å¤

å¯¹soæ–‡ä»¶è¿›è¡Œåˆ†æ

![image-20240814111139928](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814111139928.png)

ç”¨idaè¿›è¡Œåˆ†æå‘ç°å¯¼å…¥è¡¨å¯¼å‡ºè¡¨éƒ½æ— æ³•æŸ¥çœ‹

![image-20240814111725228](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814111725228.png)

æˆ‘ä»¬å¯ä»¥å°è¯•hookä¸€ä¸‹dlopenæŸ¥çœ‹åŠ è½½äº†ä»€ä¹ˆå‡½æ•°

**tipsï¼š**dlopenå’Œæ™®é€šçš„openå‡½æ•°æœ‰å•¥æœ¬è´¨åŒºåˆ«ï¼Ÿopenå‡½æ•°éƒ½å¾ˆç†Ÿæ‚‰ï¼Œæœ¬è´¨æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ‰¾åˆ°æ–‡ä»¶åœ¨ç£ç›˜çš„ä½ç½®ï¼Œç„¶åç”Ÿæˆfdï¼Œåç»­é€šè¿‡fdæ“æ§æ–‡ä»¶ï¼ç›¸æ¯”ä¹‹ä¸‹ï¼Œdlopenè¦å¤æ‚å¤šäº†ï¼šä¸ä½†è¦åŠ è½½åˆ°å†…å­˜ï¼Œè¿˜è¦è§£ææ–‡ä»¶æ ¼å¼ï¼Œç„¶åä¿®å¤é“¾æ¥

```js
function hook_dlopen() {
    Interceptor.attach(Module.findExportByName("libdl.so", "android_dlopen_ext"), {
        onEnter: function (args) {
            console.log("Load -> ", args[0].readCString());
        }, onLeave: function () {
 
        }
    })
}
 
setImmediate(hook_dlopen);
```

è¿è¡Œåå‘ç°åŠ è½½äº†ä»¥ä¸‹æ–‡ä»¶

![image-20240814112443815](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814112443815.png)

ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨fridaå°†è¿™ä¸ªsoæ–‡ä»¶dumpä¸‹æ¥
ä½¿ç”¨`frida -FU -l dump-so.js`

```js
function dump_so() {
    var soName = "libjiagu_64.so";
    var libSo = Process.getModuleByName(soName);
    var save_path = "/data/data/com.swdd.txjgtest/" + libSo.name + "_Dump";
    console.log("[Base]->", libSo.base);
    console.log("[Size]->", ptr(libSo.size));
    var handle = new File(save_path, "wb");
    Memory.protect(ptr(libSo.base), libSo.size, 'rwx');
    var Buffer = libSo.base.readByteArray(libSo.size);
    handle.write(Buffer);
    handle.flush();
    handle.close();
    console.log("[DumpPath->]", save_path);
 
}
setImmediate(dump_so);
```

![image-20240814112816204](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814112816204.png)

å°†ä»¥ä¸‹å‚æ•°ä¿å­˜ä¸‹æ¥ç•™ä½œå¤‡ç”¨

```cpp
[Base]-> 0x6f7b6c1000
[Size]-> 0x27d000
[DumpPath->] /data/data/com.swdd.txjgtest/libjiagu_64.so_Dump
```

æ¥ä¸‹æ¥å†ä½¿ç”¨SoFixeræ¥ä¿®å¤æˆ‘ä»¬dumpä¸‹æ¥çš„soæ–‡ä»¶ï¼Œ-méœ€è¦è¾“å…¥æ–‡ä»¶çš„åç§»åœ°å€

```
SoFixer.exe -s .\libjiagu_64.so_Dump -o .\libjiagu_64_fix.so -m 0x6f7b6c1000 -d
```

![image-20240814113343287](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814113343287.png)



### åŠ å›ºå£³åè°ƒè¯•åˆ†æ

æˆ‘ä»¬é¦–å…ˆhookä¸€ä¸‹ç”¨äºæ‰“å¼€soçš„æ–‡ä»¶

```js
function hook_dlopen() {
    Interceptor.attach(Module.findExportByName(null, "android_dlopen_ext"),
        {
            onEnter: function (args) {
                var pathptr = args[0];
                if (pathptr !== undefined && pathptr != null) {
                    var path = ptr(pathptr).readCString();
                    console.log("load " + path);
                }
            }
        }
    );
}

setImmediate(hook_dlopen)
```

![image-20240814114104523](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814114104523.png)

å‘ç°è¾“å‡ºå¦‚ä¸Šï¼Œæ‰€ä»¥åè°ƒè¯•æ˜¯åœ¨ `libjiagu_64.so` ä¸­

ç„¶åæˆ‘ä»¬å†å°è¯•hookä¸€ä¸‹æ‰“å¼€æ–‡ä»¶çš„å‡½æ•° `open`

![image-20240814124655630](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814124655630.png)

å¯ä»¥çœ‹åˆ°åœ¨å‰é¢å‡ ä¸ªæ‰“å¼€å‡½æ•°çš„æ“ä½œä¸­éƒ½å®šå‘åˆ°äº†`/proc/self/maps`ä¸­

`/proc/self/maps` æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†å½“å‰è¿›ç¨‹çš„å†…å­˜æ˜ å°„ä¿¡æ¯ã€‚å½“ä½ æ‰“å¼€è¿™ä¸ªæ–‡ä»¶æ—¶ï¼Œå®ƒä¼šæ˜¾ç¤ºä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶ä¸­åŒ…å«äº†è¿›ç¨‹ä¸­æ¯ä¸ªå†…å­˜åŒºåŸŸçš„è¯¦ç»†ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯é€šå¸¸åŒ…æ‹¬ï¼š

- èµ·å§‹åœ°å€ï¼ˆStart Addressï¼‰
- ç»“æŸåœ°å€ï¼ˆEnd Addressï¼‰
- æƒé™ï¼ˆå¦‚å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œï¼‰
- å…±äº«/ç§æœ‰æ ‡å¿—ï¼ˆShared or Privateï¼‰
- å…³è”çš„æ–‡ä»¶æˆ–è®¾å¤‡ï¼ˆå¦‚æœå†…å­˜åŒºåŸŸæ˜¯æ–‡ä»¶æ˜ å°„çš„ï¼‰
- å†…å­˜åŒºåŸŸçš„åç§»é‡
- å†…å­˜åŒºåŸŸçš„ç±»å‹ï¼ˆå¦‚åŒ¿åæ˜ å°„ã€æ–‡ä»¶æ˜ å°„ã€è®¾å¤‡æ˜ å°„ç­‰ï¼‰
  å½“æ³¨å…¥`frida`åï¼Œåœ¨mapsæ–‡ä»¶ä¸­å°±ä¼šå­˜åœ¨ `frida-agent-64.so`ã€`frida-agent-32.so` ç­‰æ–‡ä»¶ã€‚

æˆ‘ä»¬å°è¯•æ³¨å…¥ä»¥ä¸‹è„šæœ¬ ->

```js
function my_hook_dlopen(soName = '') {
    Interceptor.attach(Module.findExportByName(null, "android_dlopen_ext"),
        {
            onEnter: function (args) {
                var pathptr = args[0];
                if (pathptr !== undefined && pathptr != null) {
                    var path = ptr(pathptr).readCString();
                    if (path.indexOf(soName) >= 0) {
                        this.is_can_hook = true;
                    }
                }
            },
            onLeave: function (retval) {
                if (this.is_can_hook) {
                    hook_proc_self_maps();
                }
            }
        }
    );
}

function hook_proc_self_maps() {
    const openPtr = Module.getExportByName(null, 'open');
    const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']);
    var fakePath = "/data/data/com.swdd.txjgtest/maps";
    Interceptor.replace(openPtr, new NativeCallback(function (pathnameptr, flag) {
        var pathname = Memory.readUtf8String(pathnameptr);
        console.log("open",pathname);
        if (pathname.indexOf("maps") >= 0) {
            console.log("find",pathname,",redirect to",fakePath);
            var filename = Memory.allocUtf8String(fakePath);
            return open(filename, flag);
        }
        var fd = open(pathnameptr, flag);
        return fd;
    }, 'int', ['pointer', 'int']));
}


setImmediate(my_hook_dlopen,"libjiagu");
```

![image-20240814145010932](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814145010932.png)

ä½†æ˜¯å½“æ³¨å…¥è¿™æ®µè„šæœ¬åï¼Œè¿›ç¨‹ç”±äºéæ³•å†…å­˜è®¿é—®è€Œé€€å‡ºäº†ï¼Œè¿™è¯´æ˜ 360 åŠ å›ºä¸ä»…è¯»å– maps æ–‡ä»¶ï¼Œå¹¶ä¸”ä¼šå°è¯•è®¿é—® maps æ–‡ä»¶ä¸­æ‰€è®°å½•çš„æ–‡ä»¶æˆ–å†…å­˜æ˜ å°„ã€‚è¿™é‡Œç”±äº `frida` æ³¨å…¥åé‡å¯ apk, ä½†æ˜¯å¤‡ä»½çš„ maps æ–‡ä»¶ä¸­è®°å½•çš„æ˜¯å…ˆå‰çš„æ˜ å°„èµ·å§‹åœ°å€ (è¿™å—å†…å­˜åœ¨å…³é—­ apk åå°±è¢«æŠ¹å»äº†), æ‰€ä»¥å½“å£³å°è¯•è®¿é—®å…¶ä¸­çš„æ˜ å°„æ—¶äº§ç”Ÿäº†éæ³•å†…å­˜è®¿é—®ä»è€Œè®©è¿›ç¨‹å´©æºƒ

é‚£æˆ‘ä»¬å¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªmapsï¼Œä½¿å…¶åœ¨è¯»å–mapsæ–‡ä»¶çš„æ—¶å€™å®šå‘åˆ°æˆ‘ä»¬è‡ªå®šä¹‰çš„mapsä¸­ä¹‹åï¼Œå†æ³¨å…¥`frida`

```js
function addr_in_so(addr){
    var process_Obj_Module_Arr = Process.enumerateModules();
    for(var i = 0; i < process_Obj_Module_Arr.length; i++) {
        if(addr>process_Obj_Module_Arr[i].base && addr<process_Obj_Module_Arr[i].base.add(process_Obj_Module_Arr[i].size)){
            console.log(addr.toString(16),"is in",process_Obj_Module_Arr[i].name,"offset: 0x"+(addr-process_Obj_Module_Arr[i].base).toString(16));
        }
    }
}

function setRWX(){
    var Modules = Process.enumerateModules();
    for(var index = 0 ; index < Modules.length ; index ++ ){
        var Mem = Modules[index];
        // console.log("[libName]->",Mem.name);
        // console.log("[libBase]->",Mem.base);
        // console.log("[libSize]->",Mem.size);
        //console.warn("[Warning]-> "+ Mem.name + " Was setting rwx");
        Memory.protect(Mem.base,Mem.size,"rwx");
    }
}


function hook_proc_self_maps() {
    setRWX();

    var setOnce = true;
    const openPtr = Module.getExportByName(null, 'open');
    const open = new NativeFunction(openPtr, 'int', ['pointer', 'int']);
    var fakePath = "/data/data/com.swdd.txjgtest/maps";
    Interceptor.replace(openPtr, new NativeCallback(function (pathnameptr, flag) {
        var fd = open(pathnameptr, flag);
        var pathname = Memory.readUtf8String(pathnameptr);

        var filename = Memory.allocUtf8String(fakePath);
       // console.log("open",pathname);//,Process.getCurrentThreadId()
        if (pathname.indexOf("maps") >= 0) {
            //console.log("find",pathname+", redirect to",fakePath); 
            return open(filename, flag);
        }
        if (pathname.indexOf("dex") >= 0 && setOnce) {
            console.log("[OpenDex]-> ", pathname);
            console.warn('RegisterNatives called from:\n' + Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join('\n') + '\n'); //addr_in_so
        }
        
        return fd;
    }, 'int', ['pointer', 'int']));
}

function my_hook_dlopen(soName='') {
    Interceptor.attach(Module.findExportByName(null, "android_dlopen_ext"),
        {
            onEnter: function (args) {
                var pathptr = args[0];
                if (pathptr !== undefined && pathptr != null) {
                    var path = ptr(pathptr).readCString();
                    //console.log(path);
                    if (path.indexOf(soName) >= 0) {
                        this.is_can_hook = true;
                    }
                }
            },
            onLeave: function (retval) {
                if (this.is_can_hook) {
                    hook_proc_self_maps();
                }
            }
        }
    );
}
setImmediate(my_hook_dlopen,'libjiagu');

```

![image-20240814145536120](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814145536120.png)

å¯ä»¥å‘ç°æ¯æ¬¡åŠ è½½dexçš„åç§»é‡éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥ä»åœ°å€å…¥æ‰‹è¿›è¡Œåˆ†æ



`-------------------------------------------------------åˆ†å‰²çº¿---------------------------------------------------------------`



> **`Tips:`**åœ¨å¯¹ç³»ç»Ÿå‡½æ•°è¿›è¡Œ hook æ£€æµ‹æ—¶ï¼Œå‘ç°äº†ä¸€äº›å¼‚å¸¸ crashï¼Œå¹¶ä¸”åªå‘ç”Ÿåœ¨ Android 10 ç³»ç»Ÿä¸Šï¼Œç»è¿‡å¯¹é”™è¯¯æ—¥å¿—åˆ†æï¼Œç¡®è®¤è¿™æ˜¯ Android 10 æ–°å¢åŠ çš„åŠŸèƒ½ï¼šç³»ç»Ÿåº“çš„ä»£ç æ®µä¼šæ˜ å°„åˆ°å¯æ‰§è¡Œå†…å­˜ï¼Œæ²¡æœ‰è¯»æƒé™ã€‚hook æ£€æµ‹çš„é€»è¾‘æ˜¯éœ€è¦è¯»å–æŒ‡ä»¤è§£ææ¥ç¡®è®¤ï¼Œæ‰€ä»¥å¯¼è‡´äº†å¼‚å¸¸ã€‚

ä»[å®˜æ–¹ä»‹ç»](https://developer.android.com/about/versions/10/behavior-changes-all#xom-binaries) å¯çŸ¥ï¼Œå¢åŠ è¯¥åŠŸèƒ½æ˜¯ä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œå¹¶ä¸”è¯¥åŠŸèƒ½åªæ”¯æŒ AArch64 æ¶æ„ï¼Œéœ€è¦ç¡¬ä»¶å’Œ Kernel å…±åŒæ”¯æŒï¼Œç¡¬ä»¶æä¾› PAN(Privileged Access Never) å’Œ kernel æä¾› XOM(eXecute-Only Memory)ï¼Œè¯¦ç»†èµ„æ–™å¯æŸ¥çœ‹ï¼š[Execute-only Memory (XOM) for AArch64 Binaries](https://source.android.com/devices/tech/debug/execute-only-memory)

![graph](https://liwugang.github.io/assets/pictures/android/systemlib_execonly.png)

ä½†æ˜¯åœ¨ Android 11 ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä¸Šï¼Œè¯¥åŠŸèƒ½åˆè¢«æ”¾å¼ƒäº†ã€‚ä¸æ”¯æŒçš„åŸå› ä¸»è¦æ˜¯ kernel ä¸åœ¨æ”¯æŒ XOMï¼ŒåŸå› ä¹Ÿå¯ä»¥åœ¨ä¸Šé¢çš„è¯¦ç»†èµ„æ–™ä¸­æ‰¾åˆ°ã€‚

#### Android ä½¿ç”¨åŸç†

ä»ä¸Šé¢å’Œç›¸å…³èµ„æ–™å¯çŸ¥ï¼Œä¸»è¦å®ç°åœ¨ kernel å’Œç¡¬ä»¶ä¸Šï¼ŒAndroid åªæ˜¯åŠŸèƒ½çš„ä½¿ç”¨è€…ï¼Œä¸‹é¢åªè®¨è®º Android ç›¸å…³çš„é…ç½®ã€‚

Android æ˜¯ä¸€ä¸ªåºå¤§çš„ç³»ç»Ÿï¼Œä¸å¯èƒ½æœ‰äººèƒ½äº†è§£åˆ°è¯¥ç³»ç»Ÿçš„æ¯ä¸ªç»†èŠ‚ï¼Œæˆ‘ä»¬åº”è¯¥æŒæ¡æ–¹æ³•ï¼Œåœ¨é‡åˆ°ä¸æ‡‚çš„é—®é¢˜æ—¶ï¼Œèƒ½è¿ç”¨æˆ‘ä»¬çš„æ–¹æ³•å¿«é€Ÿå®šä½åˆ°é—®é¢˜ï¼Œäº†è§£å…¶å®ç°åŸç†ã€‚

é’ˆå¯¹è¯¥é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä»é”™è¯¯æ—¥å¿—å¼€å§‹å…¥æ‰‹ï¼Œç„¶åä¸€æ­¥ä¸€æ­¥æ‰¾åˆ°ç³»ç»Ÿçš„æ”¹åŠ¨å¤„ã€‚

##### é”™è¯¯æ—¥å¿—å¯¹åº”ä»£ç 

![graph](https://liwugang.github.io/assets/pictures/android/execonly_log.png)

æ ¹æ®é”™è¯¯æ—¥å¿—å¯æ‰¾åˆ°ç›¸å…³ä»£ç å¤„ï¼š

```cpp
// http://aospxref.com/android-10.0.0_r47/xref/system/core/debuggerd/libdebuggerd/tombstone.cpp?r=&mo=3649&fi=108#108
static void dump_probable_cause(log_t* log, const siginfo_t* si, unwindstack::Maps* maps) {
  std::string cause;
  if (si->si_signo == SIGSEGV && si->si_code == SEGV_MAPERR) {
    if (si->si_addr < reinterpret_cast<void*>(4096)) {
      cause = StringPrintf("null pointer dereference");
    } else if (si->si_addr == reinterpret_cast<void*>(0xffff0ffc)) {
      cause = "call to kuser_helper_version";
    } else if (si->si_addr == reinterpret_cast<void*>(0xffff0fe0)) {
      cause = "call to kuser_get_tls";
    } else if (si->si_addr == reinterpret_cast<void*>(0xffff0fc0)) {
      cause = "call to kuser_cmpxchg";
     } else if (si->si_addr == reinterpret_cast<void*>(0xffff0fa0)) {
       cause = "call to kuser_memory_barrier";
     } else if (si->si_addr == reinterpret_cast<void*>(0xffff0f60)) {
       cause = "call to kuser_cmpxchg64";
     }
   } else if (si->si_signo == SIGSEGV && si->si_code == SEGV_ACCERR) {
     unwindstack::MapInfo* map_info = maps->Find(reinterpret_cast<uint64_t>(si->si_addr));
     if (map_info != nullptr && map_info->flags == PROT_EXEC) { // è¿›ç¨‹ /proc/[pid]/maps æŸ¥è¯¢ï¼Œè‹¥æ‰¾åˆ°å¹¶ä¸”æœ‰å¯æ‰§è¡Œæƒé™
       cause = "execute-only (no-read) memory access error; likely due to data in .text.";
     }
   } else if (si->si_signo == SIGSYS && si->si_code == SYS_SECCOMP) {
     cause = StringPrintf("seccomp prevented call to disallowed %s system call %d", ABI_STRING,
                          si->si_syscall);
   }
 
   if (!cause.empty()) _LOG(log, logtype::HEADER, "Cause: %s\n", cause.c_str());
```

maps æ˜¯è¿›ç¨‹å½“å‰å†…å­˜ä¿¡æ¯ï¼Œå‡ºç°å†…å­˜è®¿é—®å¼‚å¸¸æ—¶ï¼ŒæŸ¥è¯¢å¼‚å¸¸çš„åœ°å€æ‰€åœ¨æ¨¡å—ï¼Œè‹¥æ¨¡å—å­˜åœ¨å¹¶ä¸”æœ‰å¯æ‰§è¡Œæƒé™ï¼Œåˆ™å°±æ˜¯è§¦å‘äº†ä»£ç æ®µè¯»å¼‚å¸¸ã€‚

##### å†…å­˜ä»£ç æ®µé…ç½®

æŸ¥çœ‹ Android 10 çš„è¿›ç¨‹å†…å­˜ä¸­çš„ç³»ç»Ÿåº“ï¼Œå¯¹äºä»£ç æ®µæ¥è¯´ï¼Œåªæœ‰æ‰§è¡Œæƒé™ï¼Œæ²¡æœ‰è¯»æƒé™ï¼Œå¦‚ä¸‹å›¾ï¼š

![graph](https://liwugang.github.io/assets/pictures/android/execonly_maps.png)

é’ˆå¯¹å†…å­˜ä»£ç æ®µå»æ‰è¯»æƒé™ï¼Œé¦–å…ˆçŒœæµ‹å¯èƒ½æ˜¯åœ¨ linker åœ¨åŠ å›º so æ—¶ï¼Œåšäº†ç‰¹æ®Šå¤„ç†äº†ï¼Œå»æ‰äº†è¯»æƒé™ï¼Œä½†æ˜¯é˜…è¯»äº†åŠ è½½ so çš„ä»£ç åï¼Œæœªå‘ç°æœ‰ç‰¹æ®Šå¤„ç†ã€‚ æ‰€ä»¥ï¼Œåº”è¯¥æ˜¯åœ¨æ‰“åŒ…æ˜¯è¿›è¡Œäº†ç‰¹æ®Šé…ç½®ã€‚

- æ‰€ä»¥å¯¹ä¸Šæ–¹è¯»å–mapsçš„éƒ¨åˆ†é¢„å…ˆæ‰§è¡Œ`setRWX()`ä½¿å…¶æœ‰**å¯è¯»å¯å†™å¯æ‰§è¡Œæƒé™**ï¼Œä½¿å…¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œ



### å£³elfæ–‡ä»¶é€»è¾‘åˆ†æ

åœ¨æˆ‘ä»¬è·³åˆ°è°ƒç”¨åœ°å€çš„åœ°æ–¹å¾€ä¸‹å¯»æ‰¾æŸ¥çœ‹åˆ°äº†ä¸€å¤„å¼•ç”¨

![image-20240814151359953](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814151359953.png)

ç»§ç»­å¾€ä¸Šè·Ÿè¸ªå‡½æ•°

![image-20240814152321547](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814152321547.png)

å¯ä»¥çœ‹åˆ°![image-20240814152705972](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814152705972.png)

åŸºæœ¬ä¸Šå¯ä»¥åˆ¤æ–­è¿™æ˜¯åœ¨å£³ELFä¸­å®ç°linkåŠ è½½ä¸»ELFæ–‡ä»¶äº†

### ä¸»elfæ–‡ä»¶è§£å¯†åˆ†æ

åœ¨å£³æ–‡ä»¶linkä¸»æ–‡ä»¶çš„æ—¶å€™å¿…é¡»å¾—ç”¨`dlopen`æ¥åŠ è½½æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥hookè¿™ä¸¤ä¸ªå‡½æ•°è¿›è¡Œåˆ†æ

```js
function hook_dlopen() {
    Interceptor.attach(Module.findExportByName("libdl.so", "android_dlopen_ext"), {
        onEnter: function (args) {
            console.warn("[android_dlopen_ext] -> ", args[0].readCString());
        }, onLeave: function () {
 
        }
    })
}
 
function hook_dlopen2() {
    Interceptor.attach(Module.findExportByName("libdl.so", "dlopen"), {
        onEnter: function (args) {
            console.log("[dlopen] -> ", args[0].readCString());
        }, onLeave: function () {
 
        }
    })
}
setImmediate(hook_dlopen2);
setImmediate(hook_dlopen);
```

![image-20240814152255016](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814152255016.png)

æ ¹æ®æµç¨‹å¯ä»¥çŸ¥é“æ˜¯linkåŠ å›ºsoæ–‡ä»¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ä»fixçš„æ–‡ä»¶ä¸­æ‰¾åŠ è½½çš„soæ–‡ä»¶

æ‰“å¼€010æœç´¢elfæ–‡ä»¶å¤´

![image-20240814154212859](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814154212859.png)

æˆ‘ä»¬å°†ELFæ–‡ä»¶dumpå‡ºæ¥ä½¿ç”¨ **[stalker_trace_so](https://github.com/oacia/stalker_trace_so)** è¿›è¡Œæµç¨‹åˆ†æ

```asm
call1:JNI_OnLoad
call2:j_interpreter_wrap_int64_t
call3:interpreter_wrap_int64_t
call4:_Znwm
call5:sub_13364
call6:_Znam
call7:sub_10C8C
call8:memset
call9:sub_9988
call10:sub_DE4C
call11:calloc
call12:malloc
call13:free
call14:sub_E0B4
call15:_ZdaPv
call16:sub_C3B8
call17:sub_C870
call18:sub_9538
call19:sub_9514
call20:sub_C9E0
call21:sub_C5A4
call22:sub_9674
call23:sub_15654
call24:sub_15DCC
call25:sub_15E98
call26:sub_159CC
call27:sub_1668C
call28:sub_15A4C
call29:sub_15728
call30:sub_15694
call31:sub_94B0
call32:sub_C8C8
call33:sub_CAC4
call34:sub_C810
call35:sub_906C
call36:dladdr
call37:strstr
call38:setenv
call39:_Z9__arm_a_1P7_JavaVMP7_JNIEnvPvRi
call40:sub_9A08
call41:sub_954C
call42:sub_103D0
call43:j__ZdlPv_1
call44:_ZdlPv
call45:sub_9290
call46:sub_7BAC
call47:strncpy
call48:sub_5994
call49:sub_5DF8
call50:sub_4570
call51:sub_59DC
call52:_ZN9__arm_c_19__arm_c_0Ev
call53:sub_9F60
call54:sub_957C
call55:sub_94F4
call56:sub_CC5C
call57:sub_5D38
call58:sub_5E44
call59:memcpy
call60:sub_5F4C
call61:sub_583C
call62:j__ZdlPv_3
call63:j__ZdlPv_2
call64:j__ZdlPv_0
call65:sub_9F14
call66:sub_9640
call67:sub_5894
call68:sub_58EC
call69:sub_9B90
call70:sub_2F54
call71:uncompress
call72:sub_C92C
call73:sub_440C
call74:sub_4BFC
call75:sub_4C74
call76:sub_5304
call77:sub_4E4C
call78:sub_5008
call79:mprotect
call80:strlen
call81:sub_3674
call82:dlopen
call83:sub_4340
call84:sub_3A28
call85:sub_3BDC
call86:sub_2F8C
call87:dlsym
call88:strcmp
call89:sub_5668
call90:sub_4C40
call91:sub_5BF0
call92:sub_7CDC
call93:sub_468C
call94:sub_7E08
call95:sub_86FC
call96:sub_8A84
call97:sub_7FDC
call98:interpreter_wrap_int64_t_bridge
call99:sub_9910
call100:sub_15944
call101:puts
```

å£³ elf åŠ è½½ä¸» elf, å¹¶ä¸” `program header` è¿˜è¢«åŠ å¯†äº†ï¼Œæ„Ÿè§‰è¿™ç§å½¢å¼å¾ˆåƒæ˜¯ **è‡ªå®ç° linker åŠ å›º so**

å¯¹äºè¿™ç§åŠ å›ºæ–¹å¼ï¼Œå£³ elf åœ¨ä»£ç ä¸­è‡ªå·±å®ç°äº†è§£æ ELF æ–‡ä»¶çš„å‡½æ•°ï¼Œå¹¶å°†è§£æç»“æœèµ‹å€¼åˆ° `soinfo` ç»“æ„ä½“ä¸­ï¼Œéšåè°ƒç”¨ `dlopen` è¿›è¡Œæ‰‹åŠ¨åŠ è½½

æ¥åˆ° ida é‡Œé¢åœ¨å¯¼å…¥è¡¨å¯¹ `dlopen` è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œæˆ‘ä»¬çœ‹åˆ° `dlopen` åªæœ‰ 1 ä¸ªäº¤å‰å¼•ç”¨

![image-20240814170712696](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814170712696.png)

è¿›æ¥å¯ä»¥çœ‹åˆ°ä¸€å †switchåˆ¤æ–­
![image-20240814171045156](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814171045156.png)

æŸ¥çœ‹AOSPæºç å¯ä»¥çœ‹åˆ°ä¸å…¶ä¸­çš„é¢„é“¾æ¥ ( `soinfo::prelink_image` ) è¿™éƒ¨åˆ†çš„æ“ä½œæä¸ºçš„ç›¸ä¼¼
![image-20240814175820965](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814175820965.png)

é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨idaä¸­ä½¿ç”¨`Shift+F1`å¯¼å…¥`soinfo`çš„ç»“æ„ä½“

```cpp
//IMPORTANT
//ELF64 å¯ç”¨è¯¥å®
#define __LP64__  1
//ELF32 å¯ç”¨è¯¥å®
//#define __work_around_b_24465209__  1
 
/*
//https://android.googlesource.com/platform/bionic/+/master/linker/Android.bp
æ¶æ„ä¸º 32 ä½ å®šä¹‰__work_around_b_24465209__å®
arch: {
        arm: {cflags: ["-D__work_around_b_24465209__"],},
        x86: {cflags: ["-D__work_around_b_24465209__"],},
    }
*/
 
//android-platform\bionic\libc\include\link.h
#if defined(__LP64__)
#define ElfW(type) Elf64_ ## type
#else
#define ElfW(type) Elf32_ ## type
#endif
 
//android-platform\bionic\linker\linker_common_types.h
// Android uses RELA for LP64.
#if defined(__LP64__)
#define USE_RELA 1
#endif
 
//android-platform\bionic\libc\kernel\uapi\asm-generic\int-ll64.h
//__signed__-->signed
typedef signed char __s8;
typedef unsigned char __u8;
typedef signed short __s16;
typedef unsigned short __u16;
typedef signed int __s32;
typedef unsigned int __u32;
typedef signed long long __s64;
typedef unsigned long long __u64;
 
//A12-src\msm-google\include\uapi\linux\elf.h
/* 32-bit ELF base types. */
typedef __u32   Elf32_Addr;
typedef __u16   Elf32_Half;
typedef __u32   Elf32_Off;
typedef __s32   Elf32_Sword;
typedef __u32   Elf32_Word;
 
/* 64-bit ELF base types. */
typedef __u64   Elf64_Addr;
typedef __u16   Elf64_Half;
typedef __s16   Elf64_SHalf;
typedef __u64   Elf64_Off;
typedef __s32   Elf64_Sword;
typedef __u32   Elf64_Word;
typedef __u64   Elf64_Xword;
typedef __s64   Elf64_Sxword;
 
typedef struct dynamic{
  Elf32_Sword d_tag;
  union{
    Elf32_Sword d_val;
    Elf32_Addr  d_ptr;
  } d_un;
} Elf32_Dyn;
 
typedef struct {
  Elf64_Sxword d_tag;       /* entry tag value */
  union {
    Elf64_Xword d_val;
    Elf64_Addr d_ptr;
  } d_un;
} Elf64_Dyn;
 
typedef struct elf32_rel {
  Elf32_Addr    r_offset;
  Elf32_Word    r_info;
} Elf32_Rel;
 
typedef struct elf64_rel {
  Elf64_Addr r_offset;  /* Location at which to apply the action */
  Elf64_Xword r_info;   /* index and type of relocation */
} Elf64_Rel;
 
typedef struct elf32_rela{
  Elf32_Addr    r_offset;
  Elf32_Word    r_info;
  Elf32_Sword   r_addend;
} Elf32_Rela;
 
typedef struct elf64_rela {
  Elf64_Addr r_offset;  /* Location at which to apply the action */
  Elf64_Xword r_info;   /* index and type of relocation */
  Elf64_Sxword r_addend;    /* Constant addend used to compute value */
} Elf64_Rela;
 
typedef struct elf32_sym{
  Elf32_Word    st_name;
  Elf32_Addr    st_value;
  Elf32_Word    st_size;
  unsigned char st_info;
  unsigned char st_other;
  Elf32_Half    st_shndx;
} Elf32_Sym;
 
typedef struct elf64_sym {
  Elf64_Word st_name;       /* Symbol name, index in string tbl */
  unsigned char st_info;    /* Type and binding attributes */
  unsigned char st_other;   /* No defined meaning, 0 */
  Elf64_Half st_shndx;      /* Associated section index */
  Elf64_Addr st_value;      /* Value of the symbol */
  Elf64_Xword st_size;      /* Associated symbol size */
} Elf64_Sym;
 
#define EI_NIDENT   16
 
typedef struct elf32_hdr{
  unsigned char e_ident[EI_NIDENT];
  Elf32_Half    e_type;
  Elf32_Half    e_machine;
  Elf32_Word    e_version;
  Elf32_Addr    e_entry;  /* Entry point */
  Elf32_Off e_phoff;
  Elf32_Off e_shoff;
  Elf32_Word    e_flags;
  Elf32_Half    e_ehsize;
  Elf32_Half    e_phentsize;
  Elf32_Half    e_phnum;
  Elf32_Half    e_shentsize;
  Elf32_Half    e_shnum;
  Elf32_Half    e_shstrndx;
} Elf32_Ehdr;
 
typedef struct elf64_hdr {
  unsigned char e_ident[EI_NIDENT]; /* ELF "magic number" */
  Elf64_Half e_type;
  Elf64_Half e_machine;
  Elf64_Word e_version;
  Elf64_Addr e_entry;       /* Entry point virtual address */
  Elf64_Off e_phoff;        /* Program header table file offset */
  Elf64_Off e_shoff;        /* Section header table file offset */
  Elf64_Word e_flags;
  Elf64_Half e_ehsize;
  Elf64_Half e_phentsize;
  Elf64_Half e_phnum;
  Elf64_Half e_shentsize;
  Elf64_Half e_shnum;
  Elf64_Half e_shstrndx;
} Elf64_Ehdr;
 
/* These constants define the permissions on sections in the program
   header, p_flags. */
#define PF_R        0x4
#define PF_W        0x2
#define PF_X        0x1
 
typedef struct elf32_phdr{
  Elf32_Word    p_type;
  Elf32_Off p_offset;
  Elf32_Addr    p_vaddr;
  Elf32_Addr    p_paddr;
  Elf32_Word    p_filesz;
  Elf32_Word    p_memsz;
  Elf32_Word    p_flags;
  Elf32_Word    p_align;
} Elf32_Phdr;
 
typedef struct elf64_phdr {
  Elf64_Word p_type;
  Elf64_Word p_flags;
  Elf64_Off p_offset;       /* Segment file offset */
  Elf64_Addr p_vaddr;       /* Segment virtual address */
  Elf64_Addr p_paddr;       /* Segment physical address */
  Elf64_Xword p_filesz;     /* Segment size in file */
  Elf64_Xword p_memsz;      /* Segment size in memory */
  Elf64_Xword p_align;      /* Segment alignment, file & memory */
} Elf64_Phdr;
 
typedef struct elf32_shdr {
  Elf32_Word    sh_name;
  Elf32_Word    sh_type;
  Elf32_Word    sh_flags;
  Elf32_Addr    sh_addr;
  Elf32_Off sh_offset;
  Elf32_Word    sh_size;
  Elf32_Word    sh_link;
  Elf32_Word    sh_info;
  Elf32_Word    sh_addralign;
  Elf32_Word    sh_entsize;
} Elf32_Shdr;
 
typedef struct elf64_shdr {
  Elf64_Word sh_name;       /* Section name, index in string tbl */
  Elf64_Word sh_type;       /* Type of section */
  Elf64_Xword sh_flags;     /* Miscellaneous section attributes */
  Elf64_Addr sh_addr;       /* Section virtual addr at execution */
  Elf64_Off sh_offset;      /* Section file offset */
  Elf64_Xword sh_size;      /* Size of section in bytes */
  Elf64_Word sh_link;       /* Index of another section */
  Elf64_Word sh_info;       /* Additional section information */
  Elf64_Xword sh_addralign; /* Section alignment */
  Elf64_Xword sh_entsize;   /* Entry size if section holds table */
} Elf64_Shdr;
 
//android-platform\bionic\linker\linker_soinfo.h
typedef void (*linker_dtor_function_t)();
typedef void (*linker_ctor_function_t)(int, char**, char**);
 
#if defined(__work_around_b_24465209__)
#define SOINFO_NAME_LEN 128
#endif
 
struct soinfo {
#if defined(__work_around_b_24465209__)
  char old_name_[SOINFO_NAME_LEN];
#endif
  const ElfW(Phdr)* phdr;
  size_t phnum;
#if defined(__work_around_b_24465209__)
  ElfW(Addr) unused0; // DO NOT USE, maintained for compatibility.
#endif
  ElfW(Addr) base;
  size_t size;
 
#if defined(__work_around_b_24465209__)
  uint32_t unused1;  // DO NOT USE, maintained for compatibility.
#endif
 
  ElfW(Dyn)* dynamic;
 
#if defined(__work_around_b_24465209__)
  uint32_t unused2; // DO NOT USE, maintained for compatibility
  uint32_t unused3; // DO NOT USE, maintained for compatibility
#endif
 
  soinfo* next;
  uint32_t flags_;
 
  const char* strtab_;
  ElfW(Sym)* symtab_;
 
  size_t nbucket_;
  size_t nchain_;
  uint32_t* bucket_;
  uint32_t* chain_;
 
#if !defined(__LP64__)
  ElfW(Addr)** unused4; // DO NOT USE, maintained for compatibility
#endif
 
#if defined(USE_RELA)
  ElfW(Rela)* plt_rela_;
  size_t plt_rela_count_;
 
  ElfW(Rela)* rela_;
  size_t rela_count_;
#else
  ElfW(Rel)* plt_rel_;
  size_t plt_rel_count_;
 
  ElfW(Rel)* rel_;
  size_t rel_count_;
#endif
 
  linker_ctor_function_t* preinit_array_;
  size_t preinit_array_count_;
 
  linker_ctor_function_t* init_array_;
  size_t init_array_count_;
  linker_dtor_function_t* fini_array_;
  size_t fini_array_count_;
 
  linker_ctor_function_t init_func_;
  linker_dtor_function_t fini_func_;
 
/*
#if defined (__arm__)
  // ARM EABI section used for stack unwinding.
  uint32_t* ARM_exidx;
  size_t ARM_exidx_count;
#endif
  size_t ref_count_;
// æ€ä¹ˆæ‰¾ä¸ link_map è¿™ä¸ªç±»å‹çš„å£°æ˜...
  link_map link_map_head;
 
  bool constructors_called;
 
  // When you read a virtual address from the ELF file, add this
  //value to get the corresponding address in the process' address space.
  ElfW (Addr) load_bias;
 
#if !defined (__LP64__)
  bool has_text_relocations;
#endif
  bool has_DT_SYMBOLIC;
*/
};
```

æŸ¥çœ‹ä¼ªä»£ç å‘ç°è¿˜æœ‰å¯¹ç»“æ„ä½“æœ‰ä¸€äº›é­”æ”¹çš„ç—•è¿¹

![image-20240814181508285](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814181508285.png)

å¯¹å‡½æ•°è¿›è¡Œäº¤å‰å¼•ç”¨ï¼Œç»§ç»­åˆ†æ

![image-20240814181918977](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814181918977.png)

è¿™ä¸ªå‡½æ•°ä¸­å‡ºç°äº† `0x38` è¿™ä¸ªæ•°å­—ï¼Œ `0x38` æ˜¯è¿™ä¸ªå¾ªç¯çš„æ­¥é•¿

åˆšåˆšæå–å‡ºæ¥çš„ elf ç”¨ `010editor` æ‰“å¼€ï¼Œçœ‹åˆ° `elf_header` çš„ `phentsize` è¿™ä¸ªå­—æ®µï¼Œè¿™ä¸ªå­—æ®µçš„å«ä¹‰æ˜¯ä¸€ä¸ª `Program header table` çš„é•¿åº¦ï¼Œå®ƒæ­£æ­£å¥½å¥½ä¹Ÿæ˜¯ `0x38`

![image-20240814182018994](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814182018994.png)

æ‰€ä»¥è¯´åœ¨ `sub_5668 `ä¸­å˜é‡ `v5` çš„ç±»å‹åº”è¯¥æ˜¯ `Elf64_Phdr *` , æˆ‘ä»¬ç›´æ¥é‡å®šä¹‰ç±»å‹

![image-20240814182237716](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814182237716.png)

æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†çœŸæ­£çš„`program header table`å°±æ˜¯åœ¨è¿™ä¸ªä½ç½®çš„ï¼Œé‚£æˆ‘ä»¬ä¹‹åéœ€è¦çš„è¯å°±å¯ä»¥åœ¨è¿™ä¸ªåœ°æ–¹æŠŠ`program header table`æ•´ä¸ªç»™ dump ä¸‹æ¥å°±è¡Œ

å¯¹ç…§æµç¨‹å›¾å’Œäº¤å‰å¼•ç”¨å¯ä»¥åˆ¤æ–­å‡ºæ˜¯`sub_440C-->sub_4340-->sub_5668`

ç„¶åå¯¹åº”è°ƒç”¨é“¾å¾€ä¸ŠæŸ¥çœ‹å¯¹åº”çš„å‡½æ•°

![image-20240814202647032](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814202647032.png)

ç„¶åæˆ‘ä»¬åœ¨`sub_58EC`ä¸­çœ‹åˆ°äº†ç†Ÿæ‚‰çš„`RC4`

![image-20240814203056842](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814203056842.png)

ä½†æ˜¯ç¿»äº†åŠå¤©å‡½æ•°æ²¡æœ‰çœ‹åˆ°RC4çš„åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨æ±‡ç¼–ç•Œé¢å¾€ä¸Šç¿»åˆ°æœªå£°æ˜çš„ä»£ç `loc_571C`ï¼Œå£°æ˜åå¯çœ‹åˆ°å®Œæ•´çš„å‡½æ•°
![image-20240814203738534](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814203738534.png)

æˆ‘ä»¬å°è¯•ä¸€ä¸‹hookè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼

```js
function hook_rc4(){
    var module = Process.findModuleByName("libjiagu_64.so");
    Interceptor.attach(module.base.add(0x5834), {
        // fd, buff, len
        onEnter: function (args) {
            console.log(hexdump(args[0], {
              offset: 0,// ç›¸å¯¹åç§»
              length: 0x10,//dump çš„å¤§å°
              header: true,
              ansi: true
            }));
            console.log(args[1])
            console.log(args[2])
            console.log(`base = ${module.base}`)
        },
        onLeave: function (ret) {
        }
    });
}

function my_hook_dlopen(soName='') {
    Interceptor.attach(Module.findExportByName(null, "android_dlopen_ext"),
        {
            onEnter: function (args) {
                var pathptr = args[0];
                if (pathptr !== undefined && pathptr != null) {
                    var path = ptr(pathptr).readCString();
                    //console.log(path);
                    if (path.indexOf(soName) >= 0) {
                        this.is_can_hook = true;
                    }
                }
            },
            onLeave: function (retval) {
                if (this.is_can_hook) {
                    hook_rc4();
                }
            }
        }
    );
}
setImmediate(my_hook_dlopen,'libjiagu');
```

å¾—åˆ°è¾“å‡º

![image-20240814204655501](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240814204655501.png)

æ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­`hook`rc4åŠ å¯†éƒ¨åˆ†çš„å‡½æ•°çœ‹ä¸€ä¸‹åŠ å¯†çš„æ•°æ®

![image-20240815170305561](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240815170305561.png)

```js
function hook_rc4(){
    var module = Process.findModuleByName("libjiagu_64.so");
    Interceptor.attach(module.base.add(0x5834), {
        // fd, buff, len
        onEnter: function (args) {
            console.log(hexdump(args[0], {
              offset: 0,// ç›¸å¯¹åç§»
              length: 0x10,//dump çš„å¤§å°
              header: true,
              ansi: true
            }));
            console.log(args[1])
            console.log(args[2])
            // console.log(`base = ${module.base}`)
        },
        onLeave: function (ret) {
        }
    });
}


function hook_rc4_enc(){
    var module = Process.findModuleByName("libjiagu_64.so");
    Interceptor.attach(module.base.add(0x58EC), {
        // fd, buff, len
        onEnter: function (args) {
            console.log(hexdump(args[0], {
              offset: 0,// ç›¸å¯¹åç§»
              length: 0x50,//dump çš„å¤§å°
              header: true,
              ansi: true
            }));
            console.log(args[1])
            console.log(args[2])

        },
        onLeave: function (ret) {
            
            
        }
    });
}

function my_hook_dlopen(soName='') {
    Interceptor.attach(Module.findExportByName(null, "android_dlopen_ext"),
        {
            onEnter: function (args) {
                var pathptr = args[0];
                if (pathptr !== undefined && pathptr != null) {
                    var path = ptr(pathptr).readCString();
                    //console.log(path);
                    if (path.indexOf(soName) >= 0) {
                        this.is_can_hook = true;
                    }
                }
            },
            onLeave: function (retval) {
                if (this.is_can_hook) {
                    hook_rc4();
                    hook_rc4_enc();
                }
            }
        }
    );
}
setImmediate(my_hook_dlopen,'libjiagu');
```

![image-20240815170803441](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240815170803441.png)

è¿™ä¸ª**`0xb9956`**ä¼¼ä¹åœ¨å‰é¢åŠ è½½soæ–‡ä»¶çš„å‡½æ•°ä¸­ä¸­æœ‰å‡ºç°è¿‡

![image-20240815170920369](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240815170920369.png)

æˆ‘ä»¬åœ¨æŸ¥çœ‹ `qword_2D260` ä¸­çš„æ•°æ®å¯ä»¥çœ‹åˆ°ä¸æˆ‘ä»¬hookçš„æ•°æ®ç›¸åŒ
ä¹Ÿæ˜¯ç”± `EB 57 7F BF A5 A0 33 14 04` å¼€å¤´çš„

![](https://cdn.jsdelivr.net/gh/Aar0n3906/blog-img/image-20240815172307714.png)



